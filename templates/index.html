<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m3u-checker Pro | Next Gen Dashboard</title>
    <!-- 引入高级字体与图标 -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --sidebar-grad: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --primary-grad: linear-gradient(90deg, #6366f1, #a855f7);
            --success-grad: linear-gradient(90deg, #10b981 0%, #34d399 50%, #10b981 100%);
            --danger-grad: linear-gradient(90deg, #f43f5e, #fb7185);
            --warning-grad: linear-gradient(90deg, #f59e0b, #fbbf24);
            --glass: rgba(255, 255, 255, 0.72);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9; 
            height: 100vh; 
            overflow: hidden; 
            color: #1e293b; 
        }

        /* 侧边栏美化 */
        .sidebar { 
            width: 320px; 
            background: var(--sidebar-grad); 
            height: 100vh; 
            position: fixed; 
            color: white; 
            box-shadow: 10px 0 30px rgba(79, 70, 229, 0.15); 
            z-index: 100; 
        }
        .sidebar-header { padding: 40px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sub-list { height: calc(100vh - 200px); overflow-y: auto; padding: 10px 0; }
        .sub-item { 
            padding: 18px 25px; cursor: pointer; transition: 0.3s; 
            margin: 8px 15px; border-radius: 20px; 
            background: rgba(255,255,255,0.06); border: 1px solid transparent;
        }
        .sub-item:hover { background: rgba(255,255,255,0.12); transform: translateY(-2px); }
        .sub-item.active { 
            background: white; color: #4f46e5; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            border-left: 6px solid #f59e0b;
        }

        /* 主面板样式 */
        .main { margin-left: 320px; padding: 40px; height: 100vh; overflow-y: auto; }
        .glass-card { 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.4); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.04); 
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        /* 极致渐变按钮 */
        .btn-grad { 
            border: none !important; color: white !important; border-radius: 16px; 
            font-weight: 700; padding: 12px 28px; transition: 0.3s; 
            display: inline-flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-grad:hover { transform: translateY(-4px); box-shadow: 0 12px 20px rgba(0,0,0,0.15); opacity: 0.95; }
        .btn-add { background: var(--primary-grad) !important; width: 100%; justify-content: center; }
        .btn-success-grad { background: var(--success-grad) !important; }
        .btn-danger-grad { background: var(--danger-grad) !important; }
        .btn-warning-grad { background: var(--warning-grad) !important; }

        /* 统计卡片与大图标 */
        .stat-card { padding: 30px; text-align: center; border: none; }
        .stat-card i { 
            font-size: 4.5rem; opacity: 0.08; position: absolute; 
            right: -15px; bottom: -15px; transform: rotate(-10deg);
        }
        .stat-value { font-size: 2.8rem; font-weight: 900; letter-spacing: -1px; }

        /* 流光进度条动画 */
        .progress { height: 18px; border-radius: 50px; background: #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .progress-bar { 
            background: var(--success-grad); 
            background-size: 200% 100%;
            border-radius: 50px; 
            animation: shimmer 2s linear infinite;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }
        @keyframes shimmer {
            0% { background-position: 100% 0%; }
            100% { background-position: -100% 0%; }
        }

        /* 终端控制台 */
        .console-wrapper { position: relative; margin-top: 20px; }
        .console { 
            background: #0f172a; color: #f1f5f9; height: calc(100vh - 620px); 
            min-height: 380px; overflow-y: auto; font-family: 'Fira Code', monospace; 
            font-size: 13px; padding: 25px; border-radius: 20px; border: 4px solid #1e293b; 
        }
        .log-line { margin-bottom: 5px; padding: 6px 12px; border-radius: 8px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .log-success { color: #4ade80; background: rgba(74, 222, 128, 0.05); }
        .log-fail { color: #fb7185; background: rgba(251, 113, 133, 0.05); }
        
        /* 智能滚动标签 */
        .scroll-tag { 
            position: absolute; bottom: 25px; right: 40px; 
            background: rgba(59, 130, 246, 0.9); color: white; 
            padding: 6px 16px; border-radius: 50px; font-size: 11px; 
            opacity: 0; transition: 0.4s; pointer-events: none;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .scroll-tag.show { opacity: 1; }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h3 class="fw-800 animate__animated animate__fadeInLeft">
            <i class="bi bi-cpu-fill me-2"></i> M3U Checker
        </h3>
        <button class="btn btn-grad btn-add mt-4 shadow" onclick="showAddModal()">
            <i class="bi bi-plus-circle-fill"></i> 新增订阅源
        </button>
    </div>
    <div id="subsList" class="sub-list"></div>
</div>

<div class="main">
    <div id="noSelect" class="h-100 d-flex flex-column align-items-center justify-content-center opacity-25">
        <i class="bi bi-layers display-1 mb-3"></i>
        <h2 class="fw-800">Ready to Scan</h2>
        <p>选择左侧订阅，开始极速探测</p>
    </div>

    <div id="dashboard" class="d-none animate__animated animate__fadeIn">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 id="viewName" class="fw-800 mb-0">--</h1>
                <span id="viewUrl" class="badge bg-white text-primary border shadow-sm mt-2 p-2 px-3"></span>
            </div>
            <div class="d-flex gap-3">
                <button id="runBtn" class="btn btn-grad btn-success-grad shadow-lg" onclick="startTask()">
                    <i class="bi bi-play-circle-fill"></i> 立即开始
                </button>
                <button id="stopBtn" class="btn btn-grad btn-danger-grad shadow-lg d-none" onclick="stopTask()">
                    <i class="bi bi-stop-circle-fill"></i> 停止检测
                </button>
                <button class="btn btn-grad btn-warning-grad shadow" onclick="editCurrent()">
                    <i class="bi bi-sliders"></i> 配置
                </button>
            </div>
        </div>

        <!-- 统计矩阵 -->
        <div class="row g-4 mb-5">
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-list-check"></i><div class="text-muted small fw-bold">频道总数</div><div id="statTotal" class="stat-value">0</div></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-lightning-charge-fill text-info"></i><div class="text-muted small fw-bold">已处理</div><div id="statCurrent" class="stat-value text-info">0</div></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-shield-check text-success"></i><div class="text-muted small fw-bold text-success">有效源</div><div id="statSuccess" class="stat-value text-success">0</div></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-graph-up text-primary"></i><div class="text-muted small fw-bold text-primary">成功率</div><div id="statRate" class="stat-value text-primary">0%</div></div></div>
        </div>

        <!-- 进度条区域 -->
        <div class="glass-card p-4 mb-5">
            <div class="d-flex justify-content-between small fw-800 mb-2">
                <span><i class="bi bi-radar me-1"></i> 实测进度监控</span>
                <span id="pText" class="text-primary">0%</span>
            </div>
            <div class="progress"><div id="pBar" class="progress-bar progress-bar-striped"></div></div>
        </div>

        <!-- 订阅链接卡片 -->
        <div class="row g-4 mb-4">
            <div class="col-md-6"><div class="glass-card p-4"><label class="form-label fw-bold mb-3 small text-muted text-uppercase"><i class="bi bi-link-45deg"></i> M3U 订阅</label><div class="input-group"><input type="text" id="m3uUrl" class="form-control border-0 bg-light rounded-start-4" readonly><button class="btn btn-dark rounded-end-4 px-4" onclick="copy('m3uUrl')">复制</button></div></div></div>
            <div class="col-md-6"><div class="glass-card p-4"><label class="form-label fw-bold mb-3 small text-muted text-uppercase"><i class="bi bi-file-earmark-text"></i> TXT 格式</label><div class="input-group"><input type="text" id="txtUrl" class="form-control border-0 bg-light rounded-start-4" readonly><button class="btn btn-dark rounded-end-4 px-4" onclick="copy('txtUrl')">复制</button></div></div></div>
        </div>

        <!-- 智能滚动控制台 -->
        <div class="console-wrapper">
            <div id="console" class="console shadow-lg"></div>
            <div id="scrollTag" class="scroll-tag"><i class="bi bi-pin-angle-fill me-1"></i> 自动滚动已开启</div>
        </div>
    </div>
</div>

<!-- 弹窗模态框 -->
<div class="modal fade" id="editModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0" style="border-radius:30px;">
            <div class="modal-header border-0 bg-light px-4 py-3">
                <h5 class="modal-title fw-800"><i class="bi bi-gear-fill me-2"></i> 订阅配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="editId">
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">源名称</label>
                    <input type="text" id="editName" class="form-control form-control-lg bg-light border-0" placeholder="我的 IPTV 源" style="border-radius:15px;">
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">订阅 URL (M3U/TXT)</label>
                    <input type="text" id="editUrl" class="form-control form-control-lg bg-light border-0" placeholder="http://..." style="border-radius:15px;">
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">线程数</label>
                        <input type="number" id="editThreads" class="form-control form-control-lg bg-light border-0" value="5" style="border-radius:15px;">
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">计划模式</label>
                        <select id="editMode" class="form-select form-select-lg bg-light border-0" onchange="toggleFields()" style="border-radius:15px;">
                            <option value="none">手动</option>
                            <option value="fixed">定时</option>
                            <option value="interval">间隔</option>
                        </select>
                    </div>
                </div>
                <div id="ef" class="mb-4 d-none">
                    <label class="form-label small fw-bold text-muted">执行时刻 (HH:MM)</label>
                    <input type="text" id="editTimes" class="form-control form-control-lg bg-light border-0" placeholder="08:00, 20:00" style="border-radius:15px;">
                </div>
                <div id="ei" class="mb-4 d-none">
                    <label class="form-label small fw-bold text-muted">间隔小时数</label>
                    <input type="number" id="editHours" class="form-control form-control-lg bg-light border-0" placeholder="12" style="border-radius:15px;">
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                    <button class="btn btn-outline-danger border-0 fw-bold" onclick="deleteSub()" id="delBtn">移除源</button>
                    <button class="btn btn-grad btn-primary-grad px-5 shadow" onclick="saveSub()">保存同步</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let subs = []; 
    let currentId = null; 
    let pollTimer = null;
    let autoScroll = true;

    const conBox = document.getElementById('console');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    // 智能滚动逻辑：只有接近底部才自动滚动
    conBox.addEventListener('scroll', () => {
        const atBottom = conBox.scrollHeight - conBox.scrollTop - conBox.clientHeight < 120;
        autoScroll = atBottom;
        document.getElementById('scrollTag').classList.toggle('show', autoScroll);
    });

    async function loadSubs() {
        const res = await fetch('/api/subs');
        subs = await res.json();
        const list = document.getElementById('subsList');
        list.innerHTML = subs.map(s => `
            <div class="sub-item ${s.id === currentId ? 'active' : ''}" onclick="selectSub('${s.id}')">
                <div class="fw-bold text-truncate"><i class="bi bi-hdd-network me-2"></i>${s.name}</div>
                <div class="small opacity-50 text-truncate mt-1" style="font-size:10px">${s.url}</div>
            </div>
        `).join('');
    }

    function selectSub(id) {
        currentId = id;
        document.getElementById('noSelect').classList.add('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
        const s = subs.find(x => x.id === id);
        if(!s) return;
        
        document.getElementById('viewName').innerText = s.name;
        document.getElementById('viewUrl').innerText = s.url;
        document.getElementById('m3uUrl').value = `${window.location.origin}/sub/${id}.m3u`;
        document.getElementById('txtUrl').value = `${window.location.origin}/sub/${id}.txt`;
        
        loadSubs();
        if(pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(updateStatus, 1500);
    }

    async function updateStatus() {
        if(!currentId) return;
        const res = await fetch('/api/status/' + currentId);
        const data = await res.json();
        
        document.getElementById('statTotal').innerText = data.total || 0;
        document.getElementById('statCurrent').innerText = data.current || 0;
        document.getElementById('statSuccess').innerText = data.success || 0;
        const rate = data.current > 0 ? Math.round(data.success/data.current*100) : 0;
        document.getElementById('statRate').innerText = rate + '%';
        
        const p = data.total > 0 ? Math.round(data.current/data.total*100) : 0;
        document.getElementById('pBar').style.width = p + '%';
        document.getElementById('pText').innerText = p + '%';

        const runBtn = document.getElementById('runBtn');
        const stopBtn = document.getElementById('stopBtn');
        if(data.running) {
            runBtn.classList.add('d-none'); stopBtn.classList.remove('d-none');
        } else {
            runBtn.classList.remove('d-none'); stopBtn.classList.add('d-none');
        }

        conBox.innerHTML = data.logs.map(l => {
            let cls = "";
            if(l.includes('✅')) cls = "log-success";
            if(l.includes('❌')) cls = "log-fail";
            return `<div class="log-line ${cls}">${l}</div>`;
        }).join('');
        
        if(autoScroll) conBox.scrollTop = conBox.scrollHeight;
    }

    function showAddModal() {
        document.getElementById('editId').value = "";
        document.getElementById('editName').value = "";
        document.getElementById('editUrl').value = "";
        document.getElementById('editThreads').value = 5;
        document.getElementById('editMode').value = "none";
        document.getElementById('delBtn').classList.add('d-none');
        toggleFields();
        editModal.show();
    }

    function editCurrent() {
        const s = subs.find(x => x.id === currentId);
        if(!s) return;
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editUrl').value = s.url;
        document.getElementById('editThreads').value = s.threads || 5;
        document.getElementById('editMode').value = s.schedule_mode || 'none';
        document.getElementById('editTimes').value = s.fixed_times || '';
        document.getElementById('editHours').value = s.interval_hours || 12;
        document.getElementById('delBtn').classList.remove('d-none');
        toggleFields();
        editModal.show();
    }

    function toggleFields() {
        const m = document.getElementById('editMode').value;
        document.getElementById('ef').classList.toggle('d-none', m !== 'fixed');
        document.getElementById('ei').classList.toggle('d-none', m !== 'interval');
    }

    async function saveSub() {
        const data = {
            id: document.getElementById('editId').value,
            name: document.getElementById('editName').value,
            url: document.getElementById('editUrl').value,
            threads: document.getElementById('editThreads').value,
            schedule_mode: document.getElementById('editMode').value,
            fixed_times: document.getElementById('editTimes').value,
            interval_hours: document.getElementById('editHours').value
        };
        await fetch('/api/subs', {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(data)
        });
        editModal.hide();
        loadSubs();
    }

    async function deleteSub() {
        if(confirm('⚠️ 确认彻底删除该订阅源吗？不可恢复。')) {
            await fetch('/api/subs/delete/' + currentId);
            editModal.hide();
            currentId = null;
            document.getElementById('dashboard').classList.add('d-none');
            document.getElementById('noSelect').classList.remove('d-none');
            loadSubs();
        }
    }

    function startTask() { fetch('/api/start/' + currentId); autoScroll = true; }
    function stopTask() { fetch('/api/stop/' + currentId); }
    function copy(id) {
        const el = document.getElementById(id);
        el.select();
        document.execCommand('copy');
        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "已复制";
        setTimeout(() => btn.innerText = oldText, 1500);
    }

    window.onload = loadSubs;
</script>
</body>
</html>
