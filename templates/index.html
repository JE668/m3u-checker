<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>m3u-checker ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .sub-card { border: none; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .sub-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .console { background: #1e1e1e; color: #d4d4d4; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; padding: 10px; border-radius: 5px; }
        .log-line { border-bottom: 1px solid #2d2d2d; margin-bottom: 2px; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">ğŸ“º m3u-checker è®¢é˜…ä¸­å¿ƒ</h3>
        <button class="btn btn-primary" onclick="showEditModal()">â• æ–°å¢è®¢é˜…</button>
    </div>

    <div id="subsList" class="row g-3">
        <!-- åŠ¨æ€åŠ è½½è®¢é˜…å¡ç‰‡ -->
    </div>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">è®¢é˜…é…ç½®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-2"><label class="form-label">è®¢é˜…åç§°</label><input type="text" id="editName" class="form-control" placeholder="å¦‚: æ¸¯æ¾³å°"></div>
                <div class="mb-2"><label class="form-label">è®¢é˜…é“¾æ¥ (M3U/TXT)</label><input type="text" id="editUrl" class="form-control" placeholder="http://..."></div>
                <div class="mb-2"><label class="form-label">å¹¶å‘çº¿ç¨‹</label><input type="number" id="editThreads" class="form-control" value="5"></div>
                <div class="mb-2"><label class="form-label">æ‰§è¡Œè®¡åˆ’</label>
                    <select id="editMode" class="form-select" onchange="toggleEditFields()">
                        <option value="none">æ‰‹åŠ¨æ‰§è¡Œ</option>
                        <option value="fixed">å›ºå®šç‚¹ (08:00,20:00)</option>
                        <option value="interval">æ—¶é—´é—´éš” (å°æ—¶)</option>
                    </select>
                </div>
                <div id="editFixed" class="mb-2 d-none"><input type="text" id="editTimes" class="form-control" placeholder="08:00, 20:00"></div>
                <div id="editInterval" class="mb-2 d-none"><input type="number" id="editHours" class="form-control" placeholder="12"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveSub()">ä¿å­˜é…ç½®</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let subs = [];
    const modal = new bootstrap.Modal(document.getElementById('editModal'));

    function toggleEditFields() {
        const mode = document.getElementById('editMode').value;
        document.getElementById('editFixed').classList.toggle('d-none', mode !== 'fixed');
        document.getElementById('editInterval').classList.toggle('d-none', mode !== 'interval');
    }

    async function loadSubs() {
        const res = await fetch('/api/subs');
        subs = await res.json();
        const list = document.getElementById('subsList');
        list.innerHTML = subs.map(s => `
            <div class="col-md-6">
                <div class="card sub-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="fw-bold">${s.name} <small class="text-muted" style="font-size:10px">ID:${s.id}</small></h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="showEditModal('${s.id}')">âš™ï¸</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSub('${s.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <p class="text-truncate small text-muted">${s.url}</p>
                        <div class="btn-group w-100 mb-3">
                            <button class="btn btn-sm btn-success" onclick="startTask('${s.id}')">ğŸš€ æ£€æµ‹</button>
                            <button class="btn btn-sm btn-danger d-none" id="stop-${s.id}" onclick="stopTask('${s.id}')">ğŸ›‘ åœæ­¢</button>
                            <a href="/sub/${s.id}.m3u" class="btn btn-sm btn-outline-dark" target="_blank">M3U</a>
                            <a href="/sub/${s.id}.txt" class="btn btn-sm btn-outline-dark" target="_blank">TXT</a>
                        </div>
                        <div class="progress mb-2" style="height:5px"><div id="pbar-${s.id}" class="progress-bar bg-success" style="width:0%"></div></div>
                        <div id="console-${s.id}" class="console"></div>
                    </div>
                </div>
            </div>
        `).join('');
        subs.forEach(s => pollStatus(s.id));
    }

    function showEditModal(id) {
        const s = subs.find(item => item.id === id) || {name:'', url:'', threads:5, schedule_mode:'none', fixed_times:'', interval_hours:12};
        document.getElementById('editId').value = id || '';
        document.getElementById('editName').value = s.name;
        document.getElementById('editUrl').value = s.url;
        document.getElementById('editThreads').value = s.threads;
        document.getElementById('editMode').value = s.schedule_mode;
        document.getElementById('editTimes').value = s.fixed_times;
        document.getElementById('editHours').value = s.interval_hours;
        toggleEditFields();
        modal.show();
    }

    async function saveSub() {
        const data = {
            id: document.getElementById('editId').value,
            name: document.getElementById('editName').value,
            url: document.getElementById('editUrl').value,
            threads: document.getElementById('editThreads').value,
            schedule_mode: document.getElementById('editMode').value,
            fixed_times: document.getElementById('editTimes').value,
            interval_hours: document.getElementById('editHours').value
        };
        await fetch('/api/subs', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        modal.hide();
        loadSubs();
    }

    async function deleteSub(id) { if(confirm('ç¡®å®šåˆ é™¤?')) { await fetch('/api/subs/delete/'+id); loadSubs(); } }
    function startTask(id) { fetch('/api/start/'+id); }
    function stopTask(id) { fetch('/api/stop/'+id); }

    function pollStatus(id) {
        setInterval(async () => {
            const res = await fetch('/api/status/'+id);
            const data = await res.json();
            const con = document.getElementById('console-'+id);
            const pbar = document.getElementById('pbar-'+id);
            const stopBtn = document.getElementById('stop-'+id);

            if(data.running) stopBtn.classList.remove('d-none'); else stopBtn.classList.add('d-none');
            if(data.total > 0) pbar.style.width = (data.current/data.total*100)+'%';
            con.innerHTML = data.logs.slice(-50).map(l => `<div class="log-line">${l}</div>`).join('');
            con.scrollTop = con.scrollHeight;
        }, 2000);
    }

    window.onload = loadSubs;
</script>
</body>
</html>
