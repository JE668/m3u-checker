<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>m3u-checker Pro Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --sidebar: #0f172a; --glass: rgba(255, 255, 255, 0.9); }
        body { background: #f1f5f9; height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        /* ä¾§è¾¹æ ç¾åŒ– */
        .sidebar { width: 300px; background: var(--sidebar); height: 100vh; position: fixed; color: white; transition: 0.3s; }
        .sub-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .sub-item:hover { background: rgba(255,255,255,0.1); }
        .sub-item.active { background: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5); }

        /* ä¸»é¢æ¿ç¾åŒ– */
        .main { margin-left: 300px; padding: 30px; height: 100vh; overflow-y: auto; }
        .glass-card { background: var(--glass); backdrop-filter: blur(10px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .stat-card { text-align: center; padding: 20px; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        
        .console { background: #1e293b; color: #f8fafc; height: calc(100vh - 550px); min-height: 350px; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 13px; padding: 20px; border-radius: 12px; }
        .log-line { margin-bottom: 3px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-success { color: #4ade80; }
        .log-fail { color: #f87171; }
        
        .progress { height: 12px; border-radius: 20px; background: #e2e8f0; overflow: hidden; }
        .btn-primary { background: #3b82f6; border: none; border-radius: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="p-4 border-bottom border-secondary">
        <h4 class="fw-bold"><i class="bi bi-cpu-fill text-primary"></i> m3u-checker</h4>
        <button class="btn btn-primary w-100 mt-3" onclick="showAddModal()"><i class="bi bi-plus-lg"></i> æ–°å¢è®¢é˜…</button>
    </div>
    <div id="subsList" class="mt-2"></div>
</div>

<div class="main">
    <div id="noSelect" class="h-100 d-flex flex-column align-items-center justify-content-center opacity-50">
        <i class="bi bi-hdd-network display-1 mb-3"></i>
        <h3>è¯·ä»å·¦ä¾§é€‰æ‹©è®¢é˜…ä»»åŠ¡</h3>
    </div>

    <div id="dashboard" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 id="viewName" class="fw-bold mb-0">--</h2>
                <span id="viewUrl" class="text-muted small"></span>
            </div>
            <div class="btn-group">
                <button id="runBtn" class="btn btn-success px-4" onclick="startTask()"><i class="bi bi-play-fill"></i> æ‰§è¡Œæ£€æµ‹</button>
                <button id="stopBtn" class="btn btn-danger px-4 d-none" onclick="stopTask()"><i class="bi bi-stop-fill"></i> åœæ­¢</button>
                <button class="btn btn-secondary px-3" onclick="editCurrent()"><i class="bi bi-gear"></i></button>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-list-ol stat-icon text-primary"></i><div>æ€»é¢‘é“</div><h3 id="statTotal">0</h3></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-activity stat-icon text-info"></i><div>å·²å¤„ç†</div><h3 id="statCurrent">0</h3></div></div>
            <div class="col-md-3"><div class="glass-card stat-card text-success"><i class="bi bi-check-circle stat-icon"></i><div>æœ‰æ•ˆæº</div><h3 id="statSuccess">0</h3></div></div>
            <div class="col-md-3"><div class="glass-card stat-card text-primary"><i class="bi bi-pie-chart stat-icon"></i><div>æˆåŠŸç‡</div><h3 id="statRate">0%</h3></div></div>
        </div>

        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between small fw-bold mb-2"><span>ğŸ” æ¢æµ‹å®æ—¶è¿›åº¦</span><span id="pText">0%</span></div>
            <div class="progress"><div id="pBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6"><div class="glass-card p-3"><label class="form-label fw-bold"><i class="bi bi-link-45deg"></i> M3U åœ°å€</label><div class="input-group"><input type="text" id="m3uUrl" class="form-control" readonly><button class="btn btn-dark" onclick="copy('m3uUrl')">å¤åˆ¶</button></div></div></div>
            <div class="col-md-6"><div class="glass-card p-3"><label class="form-label fw-bold"><i class="bi bi-file-text"></i> TXT åœ°å€</label><div class="input-group"><input type="text" id="txtUrl" class="form-control" readonly><button class="btn btn-dark" onclick="copy('txtUrl')">å¤åˆ¶</button></div></div></div>
        </div>

        <div id="console" class="console shadow-lg"></div>
    </div>
</div>

<!-- é…ç½®å¼¹çª— -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content shadow border-0" style="border-radius:20px;">
        <div class="modal-header border-0 px-4 pt-4"><h5 class="modal-title fw-bold">è®¢é˜…é…ç½®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body px-4 pb-4">
            <input type="hidden" id="editId">
            <div class="mb-3"><label class="form-label small fw-bold">åç§°</label><input type="text" id="editName" class="form-control"></div>
            <div class="mb-3"><label class="form-label small fw-bold">è®¢é˜…é“¾æ¥</label><input type="text" id="editUrl" class="form-control"></div>
            <div class="row g-2 mb-3">
                <div class="col-6"><label class="form-label small fw-bold">çº¿ç¨‹</label><input type="number" id="editThreads" class="form-control" value="5"></div>
                <div class="col-6"><label class="form-label small fw-bold">æ¨¡å¼</label><select id="editMode" class="form-select" onchange="toggleFields()"><option value="none">æ‰‹åŠ¨</option><option value="fixed">å®šæ—¶</option><option value="interval">é—´éš”</option></select></div>
            </div>
            <div id="ef" class="mb-3 d-none"><label class="form-label small fw-bold">æ—¶åˆ» (08:00...)</label><input type="text" id="editTimes" class="form-control"></div>
            <div id="ei" class="mb-3 d-none"><label class="form-label small fw-bold">é—´éš” (å°æ—¶)</label><input type="number" id="editHours" class="form-control"></div>
            <div class="d-flex justify-content-between mt-4"><button class="btn btn-outline-danger" onclick="deleteSub()" id="delBtn">åˆ é™¤</button><button class="btn btn-primary px-5" onclick="saveSub()">ä¿å­˜é…ç½®</button></div>
        </div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let subs = []; let currentId = null; let poll = null;
    const modal = new bootstrap.Modal(document.getElementById('editModal'));

    async function loadSubs() {
        const res = await fetch('/api/subs'); subs = await res.json();
        document.getElementById('subsList').innerHTML = subs.map(s => `
            <div class="sub-item ${s.id === currentId ? 'active' : ''}" onclick="selectSub('${s.id}')">
                <div class="fw-bold text-truncate">${s.name}</div>
                <div class="small opacity-50 text-truncate" style="font-size:10px">${s.url}</div>
            </div>
        `).join('');
    }

    function selectSub(id) {
        currentId = id; document.getElementById('noSelect').classList.add('d-none'); document.getElementById('dashboard').classList.remove('d-none');
        const s = subs.find(x => x.id === id);
        document.getElementById('viewName').innerText = s.name;
        document.getElementById('viewUrl').innerText = s.url;
        document.getElementById('m3uUrl').value = `${window.location.origin}/sub/${id}.m3u`;
        document.getElementById('txtUrl').value = `${window.location.origin}/sub/${id}.txt`;
        loadSubs(); if(poll) clearInterval(poll); poll = setInterval(updateStatus, 1500);
    }

    async function updateStatus() {
        if(!currentId) return;
        const res = await fetch('/api/status/' + currentId); const data = await res.json();
        document.getElementById('statTotal').innerText = data.total;
        document.getElementById('statCurrent').innerText = data.current;
        document.getElementById('statSuccess').innerText = data.success;
        document.getElementById('statRate').innerText = (data.current>0?Math.round(data.success/data.current*100):0) + '%';
        const p = data.total>0?Math.round(data.current/data.total*100):0;
        document.getElementById('pBar').style.width = p + '%'; document.getElementById('pText').innerText = p + '%';
        const rb = document.getElementById('runBtn'); const sb = document.getElementById('stopBtn');
        if(data.running){ rb.classList.add('d-none'); sb.classList.remove('d-none'); } else { rb.classList.remove('d-none'); sb.classList.add('d-none'); }
        document.getElementById('console').innerHTML = data.logs.map(l => {
            let cls = ""; if(l.includes('âœ…')) cls="log-success"; if(l.includes('âŒ')) cls="log-fail";
            return `<div class="log-line ${cls}">${l}</div>`;
        }).join('');
        document.getElementById('console').scrollTop = 999999;
    }

    function showAddModal() { document.getElementById('editId').value=""; document.getElementById('editName').value=""; document.getElementById('editUrl').value=""; document.getElementById('delBtn').classList.add('d-none'); modal.show(); }
    function editCurrent() { const s = subs.find(x => x.id === currentId); document.getElementById('editId').value=s.id; document.getElementById('editName').value=s.name; document.getElementById('editUrl').value=s.url; document.getElementById('editThreads').value=s.threads||5; document.getElementById('editMode').value=s.schedule_mode||'none'; document.getElementById('editTimes').value=s.fixed_times||''; document.getElementById('editHours').value=s.interval_hours||12; document.getElementById('delBtn').classList.remove('d-none'); toggleFields(); modal.show(); }
    function toggleFields() { const m=document.getElementById('editMode').value; document.getElementById('ef').classList.toggle('d-none', m!=='fixed'); document.getElementById('ei').classList.toggle('d-none', m!=='interval'); }
    async function saveSub() { const data = { id: document.getElementById('editId').value, name: document.getElementById('editName').value, url: document.getElementById('editUrl').value, threads: document.getElementById('editThreads').value, schedule_mode: document.getElementById('editMode').value, fixed_times: document.getElementById('editTimes').value, interval_hours: document.getElementById('editHours').value }; await fetch('/api/subs', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); modal.hide(); loadSubs(); }
    async function deleteSub() { if(confirm('åˆ é™¤?')){ await fetch('/api/subs/delete/'+currentId); modal.hide(); currentId=null; document.getElementById('dashboard').classList.add('d-none'); document.getElementById('noSelect').classList.remove('d-none'); loadSubs(); } }
    function startTask() { fetch('/api/start/'+currentId); }
    function stopTask() { fetch('/api/stop/'+currentId); }
    function copy(id) { const el=document.getElementById(id); el.select(); document.execCommand('copy'); alert('å·²å¤åˆ¶'); }
    window.onload = loadSubs;
</script>
</body>
</html>
