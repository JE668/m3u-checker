<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m3u-checker Pro | Dashboard</title>
    <!-- 字体与库 -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --sidebar-grad: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --primary-grad: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --success-grad: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --danger-grad: linear-gradient(135deg, #f43f5e 0%, #fb7185 100%);
            --warning-grad: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --glass: rgba(255, 255, 255, 0.75);
            --card-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9; height: 100vh; overflow: hidden; color: #1e293b; 
        }

        /* 侧边栏 */
        .sidebar { 
            width: 320px; background: var(--sidebar-grad); height: 100vh; position: fixed; 
            color: white; box-shadow: 10px 0 30px rgba(79, 70, 229, 0.15); z-index: 100; 
        }
        .sidebar-header { padding: 40px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sub-list { height: calc(100vh - 200px); overflow-y: auto; padding: 10px 0; }
        .sub-item { 
            padding: 18px 25px; cursor: pointer; transition: 0.3s; 
            margin: 8px 15px; border-radius: 18px; 
            background: rgba(255,255,255,0.05); border: 1px solid transparent;
        }
        .sub-item:hover { background: rgba(255,255,255,0.12); transform: translateY(-2px); }
        .sub-item.active { 
            background: white; color: #4f46e5; box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            border-left: 5px solid #f59e0b;
        }

        /* 主面板 */
        .main { margin-left: 320px; padding: 40px; height: 100vh; overflow-y: auto; }
        .glass-card { 
            background: var(--glass); backdrop-filter: blur(20px); border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.4); box-shadow: var(--card-shadow); transition: 0.3s;
        }

        /* 渐变按钮修复版 */
        .btn-grad { 
            border: none !important; color: white !important; border-radius: 14px; 
            font-weight: 700; padding: 12px 24px; transition: 0.3s; 
            display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-grad:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); color: white !important; opacity: 0.95; }
        .btn-primary-grad { background: var(--primary-grad) !important; }
        .btn-success-grad { background: var(--success-grad) !important; }
        .btn-danger-grad { background: var(--danger-grad) !important; }
        .btn-warning-grad { background: var(--warning-grad) !important; }
        
        /* 移除源按钮特殊处理 */
        .btn-outline-danger-custom {
            background: transparent; color: #f43f5e !important; border: 2px solid #f43f5e !important;
            border-radius: 14px; padding: 10px 20px; font-weight: 700; transition: 0.3s;
        }
        .btn-outline-danger-custom:hover { background: #f43f5e; color: white !important; transform: translateY(-3px); }

        /* 统计卡片 */
        .stat-card { padding: 30px; text-align: center; position: relative; overflow: hidden; border: none; }
        .stat-card i { 
            font-size: 3.5rem; opacity: 0.08; position: absolute; right: -10px; bottom: -10px; transform: rotate(-15deg);
        }
        .stat-value { font-size: 2.5rem; font-weight: 800; margin-top: 5px; }

        /* 控制台 */
        .console-wrapper { position: relative; }
        .console { 
            background: #0f172a; color: #f8fafc; height: calc(100vh - 580px); 
            min-height: 380px; overflow-y: auto; font-family: 'Fira Code', monospace; 
            font-size: 13px; padding: 25px; border-radius: 20px; border: 4px solid #1e293b; 
        }
        .log-line { margin-bottom: 4px; padding: 4px 8px; border-radius: 6px; }
        .log-success { color: #4ade80; background: rgba(74, 222, 128, 0.05); }
        .log-fail { color: #fb7185; background: rgba(251, 113, 133, 0.05); }
        
        .scroll-tag { 
            position: absolute; bottom: 20px; right: 40px; background: rgba(59, 130, 246, 0.9); 
            color: white; padding: 5px 15px; border-radius: 50px; font-size: 11px; 
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .scroll-tag.show { opacity: 1; }

        .progress { height: 16px; border-radius: 50px; background: #e2e8f0; }
        .progress-bar { background: var(--success-grad); border-radius: 50px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h3 class="fw-800"><i class="bi bi-cpu-fill me-2"></i> Checker</h3>
        <button class="btn btn-grad btn-primary-grad w-100 mt-4 shadow" onclick="showAddModal()">
            <i class="bi bi-plus-circle-fill"></i> 新增订阅源
        </button>
    </div>
    <div id="subsList" class="sub-list"></div>
</div>

<div class="main">
    <div id="noSelect" class="h-100 d-flex flex-column align-items-center justify-content-center opacity-25">
        <i class="bi bi-intersect display-1 mb-3"></i>
        <h2 class="fw-800">Ready to Probe</h2>
        <p>从左侧面板选择一个源，开启自动化检测</p>
    </div>

    <div id="dashboard" class="d-none animate__animated animate__fadeIn">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 id="viewName" class="fw-800 mb-0">--</h1>
                <span id="viewUrl" class="badge bg-white text-primary border shadow-sm mt-2 p-2 px-3"></span>
            </div>
            <div class="d-flex gap-3">
                <button id="runBtn" class="btn btn-grad btn-success-grad shadow-lg" onclick="startTask()">
                    <i class="bi bi-play-circle-fill"></i> 执行检测
                </button>
                <button id="stopBtn" class="btn btn-grad btn-danger-grad shadow-lg d-none" onclick="stopTask()">
                    <i class="bi bi-stop-circle-fill"></i> 停止检测
                </button>
                <button class="btn btn-grad btn-warning-grad shadow" onclick="editCurrent()">
                    <i class="bi bi-sliders"></i> 配置
                </button>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-collection-play"></i><div class="text-muted small fw-bold">频道总数</div><div id="statTotal" class="stat-value">0</div></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-lightning-charge"></i><div class="text-muted small fw-bold">已处理</div><div id="statCurrent" class="stat-value">0</div></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-shield-check text-success"></i><div class="text-muted small fw-bold text-success">有效源</div><div id="statSuccess" class="stat-value text-success">0</div></div></div>
            <div class="col-md-3"><div class="glass-card stat-card"><i class="bi bi-graph-up text-primary"></i><div class="text-muted small fw-bold text-primary">成功率</div><div id="statRate" class="stat-value text-primary">0%</div></div></div>
        </div>

        <div class="glass-card p-4 mb-5">
            <div class="d-flex justify-content-between small fw-800 mb-2"><span><i class="bi bi-radar me-1"></i> 实测进度</span><span id="pText" class="text-primary">0%</span></div>
            <div class="progress"><div id="pBar" class="progress-bar progress-bar-striped progress-bar-animated shadow-sm"></div></div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-6"><div class="glass-card p-4"><label class="form-label fw-bold mb-3 small text-muted text-uppercase">M3U 订阅地址</label><div class="input-group"><input type="text" id="m3uUrl" class="form-control border-0 bg-light rounded-start-4" readonly><button class="btn btn-dark rounded-end-4 px-4" onclick="copy('m3uUrl')">复制</button></div></div></div>
            <div class="col-md-6"><div class="glass-card p-4"><label class="form-label fw-bold mb-3 small text-muted text-uppercase">TXT 格式地址</label><div class="input-group"><input type="text" id="txtUrl" class="form-control border-0 bg-light rounded-start-4" readonly><button class="btn btn-dark rounded-end-4 px-4" onclick="copy('txtUrl')">复制</button></div></div></div>
        </div>

        <div class="console-wrapper">
            <div id="console" class="console shadow-lg"></div>
            <div id="scrollTag" class="scroll-tag shadow"><i class="bi bi-pin-angle-fill me-1"></i> 自动滚动已开启</div>
        </div>
    </div>
</div>

<!-- 弹窗：已应用最终样式修复 -->
<div class="modal fade" id="editModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0" style="border-radius:30px;">
            <div class="modal-header border-0 bg-light px-4 py-3">
                <h5 class="modal-title fw-800"><i class="bi bi-gear-fill me-2"></i> 订阅配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="editId">
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">源名称</label>
                    <input type="text" id="editName" class="form-control form-control-lg bg-light border-0" placeholder="我的订阅名称" style="border-radius: 14px;">
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">订阅链接</label>
                    <input type="text" id="editUrl" class="form-control form-control-lg bg-light border-0" placeholder="M3U 或 TXT 链接" style="border-radius: 14px;">
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">并发线程</label>
                        <input type="number" id="editThreads" class="form-control form-control-lg bg-light border-0" value="5" style="border-radius: 14px;">
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">执行计划</label>
                        <select id="editMode" class="form-select form-select-lg bg-light border-0" onchange="toggleFields()" style="border-radius: 14px;">
                            <option value="none">手动执行</option>
                            <option value="fixed">定时点</option>
                            <option value="interval">时间间隔</option>
                        </select>
                    </div>
                </div>
                <div id="ef" class="mb-4 d-none">
                    <label class="form-label small fw-bold text-muted">执行时刻 (HH:MM, 逗号分隔)</label>
                    <input type="text" id="editTimes" class="form-control form-control-lg bg-light border-0" placeholder="08:00, 20:00" style="border-radius: 14px;">
                </div>
                <div id="ei" class="mb-4 d-none">
                    <label class="form-label small fw-bold text-muted">间隔小时数</label>
                    <input type="number" id="editHours" class="form-control form-control-lg bg-light border-0" placeholder="12" style="border-radius: 14px;">
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                    <button class="btn-outline-danger-custom" onclick="deleteSub()" id="delBtn">
                        <i class="bi bi-trash3-fill"></i> 移除源
                    </button>
                    <button class="btn-grad btn-primary-grad px-5" onclick="saveSub()">
                        <i class="bi bi-cloud-arrow-up-fill"></i> 保存同步
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let subs = []; let currentId = null; let pollTimer = null; let autoScroll = true;
    const conBox = document.getElementById('console');
    const editModalObj = new bootstrap.Modal(document.getElementById('editModal'));

    conBox.addEventListener('scroll', () => {
        const atBottom = conBox.scrollHeight - conBox.scrollTop - conBox.clientHeight < 100;
        autoScroll = atBottom;
        document.getElementById('scrollTag').classList.toggle('show', autoScroll);
    });

    async function loadSubs() {
        const res = await fetch('/api/subs'); subs = await res.json();
        document.getElementById('subsList').innerHTML = subs.map(s => `
            <div class="sub-item ${s.id === currentId ? 'active' : ''}" onclick="selectSub('${s.id}')">
                <div class="fw-bold text-truncate"><i class="bi bi-hdd-stack me-2"></i>${s.name}</div>
                <div class="small opacity-50 text-truncate mt-1" style="font-size:10px">${s.url}</div>
            </div>
        `).join('');
    }

    function selectSub(id) {
        currentId = id; document.getElementById('noSelect').classList.add('d-none'); document.getElementById('dashboard').classList.remove('d-none');
        const s = subs.find(x => x.id === id); if(!s) return;
        document.getElementById('viewName').innerText = s.name;
        document.getElementById('viewUrl').innerText = s.url;
        document.getElementById('m3uUrl').value = `${window.location.origin}/sub/${id}.m3u`;
        document.getElementById('txtUrl').value = `${window.location.origin}/sub/${id}.txt`;
        loadSubs(); if(pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(updateStatus, 1500);
    }

    async function updateStatus() {
        if(!currentId) return;
        const res = await fetch('/api/status/' + currentId); const data = await res.json();
        document.getElementById('statTotal').innerText = data.total || 0;
        document.getElementById('statCurrent').innerText = data.current || 0;
        document.getElementById('statSuccess').innerText = data.success || 0;
        const rate = data.current > 0 ? Math.round(data.success/data.current*100) : 0;
        document.getElementById('statRate').innerText = rate + '%';
        const p = data.total > 0 ? Math.round(data.current/data.total*100) : 0;
        document.getElementById('pBar').style.width = p + '%'; document.getElementById('pText').innerText = p + '%';
        if(data.running){
            document.getElementById('runBtn').classList.add('d-none'); document.getElementById('stopBtn').classList.remove('d-none');
        } else {
            document.getElementById('runBtn').classList.remove('d-none'); document.getElementById('stopBtn').classList.add('d-none');
        }
        conBox.innerHTML = data.logs.map(l => {
            let cls = ""; if(l.includes('✅')) cls = "log-success"; if(l.includes('❌')) cls = "log-fail";
            return `<div class="log-line ${cls}">${l}</div>`;
        }).join('');
        if(autoScroll) conBox.scrollTop = conBox.scrollHeight;
    }

    function showAddModal() {
        document.getElementById('editId').value = "";
        document.getElementById('editName').value = "";
        document.getElementById('editUrl').value = "";
        document.getElementById('editThreads').value = 5;
        document.getElementById('editMode').value = "none";
        document.getElementById('delBtn').classList.add('d-none');
        toggleFields(); editModalObj.show();
    }

    function editCurrent() {
        const s = subs.find(x => x.id === currentId); if(!s) return;
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editUrl').value = s.url;
        document.getElementById('editThreads').value = s.threads || 5;
        document.getElementById('editMode').value = s.schedule_mode || 'none';
        document.getElementById('editTimes').value = s.fixed_times || '';
        document.getElementById('editHours').value = s.interval_hours || 12;
        document.getElementById('delBtn').classList.remove('d-none');
        toggleFields(); editModalObj.show();
    }

    function toggleFields() {
        const m = document.getElementById('editMode').value;
        document.getElementById('ef').classList.toggle('d-none', m !== 'fixed');
        document.getElementById('ei').classList.toggle('d-none', m !== 'interval');
    }

    async function saveSub() {
        const data = {
            id: document.getElementById('editId').value,
            name: document.getElementById('editName').value,
            url: document.getElementById('editUrl').value,
            threads: document.getElementById('editThreads').value,
            schedule_mode: document.getElementById('editMode').value,
            fixed_times: document.getElementById('editTimes').value,
            interval_hours: document.getElementById('editHours').value
        };
        const res = await fetch('/api/subs', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
        });
        if(res.ok) { editModalObj.hide(); loadSubs(); }
    }

    async function deleteSub() {
        if(confirm('⚠️ 确认彻底删除该订阅源吗？不可恢复。')) {
            await fetch('/api/subs/delete/' + currentId);
            editModalObj.hide(); currentId = null;
            document.getElementById('dashboard').classList.add('d-none');
            document.getElementById('noSelect').classList.remove('d-none');
            loadSubs();
        }
    }

    function startTask() { fetch('/api/start/' + currentId); autoScroll = true; }
    function stopTask() { fetch('/api/stop/' + currentId); }
    function copy(id) {
        const el = document.getElementById(id); el.select(); document.execCommand('copy');
        const btn = event.target; const oldText = btn.innerText;
        btn.innerText = "已复制"; setTimeout(() => btn.innerText = oldText, 1500);
    }
    window.onload = loadSubs;
</script>
</body>
</html>
