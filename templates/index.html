<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>m3u-checker Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --sidebar-width: 320px; }
        body { background: #f0f2f5; height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #ddd; height: 100vh; overflow-y: auto; position: fixed; left: 0; top: 0; }
        .main-content { margin-left: var(--sidebar-width); height: 100vh; overflow-y: auto; padding: 25px; }
        .sub-item { cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: 0.2s; }
        .sub-item:hover { background: #f8f9fa; }
        .sub-item.active { background: #e7f1ff; border-left: 4px solid #0d6efd; }
        .console { background: #1e1e1e; color: #d4d4d4; height: calc(100vh - 350px); overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; padding: 15px; border-radius: 8px; box-shadow: inset 0 0 10px #000; }
        .log-line { margin-bottom: 3px; border-bottom: 1px solid #2d2d2d; padding-bottom: 2px; }
        .log-success { color: #4ec9b0; }
        .log-fail { color: #f48771; }
    </style>
</head>
<body>

<!-- å·¦ä¾§ç®¡ç†æ  -->
<div class="sidebar">
    <div class="p-3 bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">ğŸ“º è®¢é˜…ä¸­å¿ƒ</h5>
        <button class="btn btn-sm btn-light" onclick="showEditModal()">+</button>
    </div>
    <div id="subsList">
        <!-- è®¢é˜…åˆ—è¡¨ -->
    </div>
</div>

<!-- å³ä¾§ä¸»ä»ªè¡¨ç›˜ -->
<div class="main-content">
    <div id="noSelect" class="text-center mt-5 text-muted">
        <h3>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè®¢é˜…æº</h3>
    </div>

    <div id="dashboard" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 id="viewName" class="fw-bold text-dark mb-1">--</h2>
                <small id="viewUrl" class="text-muted"></small>
            </div>
            <div class="btn-group">
                <button id="runBtn" class="btn btn-success px-4" onclick="startTask()">æ‰§è¡Œæ£€æµ‹</button>
                <button id="stopBtn" class="btn btn-danger d-none" onclick="stopTask()">åœæ­¢ä»»åŠ¡</button>
                <button class="btn btn-outline-secondary" onclick="editCurrent()">é…ç½®</button>
            </div>
        </div>

        <div class="row g-3 mb-4 text-center">
            <div class="col-md-3"><div class="card p-3 border-0"><div>æ€»é¢‘é“</div><h3 id="statTotal" class="fw-bold">0</h3></div></div>
            <div class="col-md-3"><div class="card p-3 border-0"><div>å·²å¤„ç†</div><h3 id="statCurrent" class="fw-bold">0</h3></div></div>
            <div class="col-md-3"><div class="card p-3 border-0 text-success"><div>æœ‰æ•ˆæº</div><h3 id="statSuccess" class="fw-bold">0</h3></div></div>
            <div class="col-md-3"><div class="card p-3 border-0 text-primary"><div>æˆåŠŸç‡</div><h3 id="statRate" class="fw-bold">0%</h3></div></div>
        </div>

        <div class="card border-0 mb-4 p-3">
            <div class="d-flex justify-content-between mb-2 small fw-bold">
                <span>å®æ—¶è¿›åº¦</span>
                <span id="pText">0%</span>
            </div>
            <div class="progress" style="height:12px;"><div id="pBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"></div></div>
        </div>

        <div class="card border-0 p-3 mb-4">
            <h6>ğŸ”— ç»“æœåˆ†å‘</h6>
            <div class="input-group">
                <span class="input-group-text">M3U è®¢é˜…</span>
                <input type="text" id="m3uUrl" class="form-control" readonly>
                <button class="btn btn-primary" onclick="copyUrl('m3uUrl')">å¤åˆ¶</button>
                <a id="m3uDl" class="btn btn-dark" target="_blank">ä¸‹è½½</a>
            </div>
            <div class="input-group mt-2">
                <span class="input-group-text">TXT æ ¼å¼</span>
                <input type="text" id="txtUrl" class="form-control" readonly>
                <button class="btn btn-primary" onclick="copyUrl('txtUrl')">å¤åˆ¶</button>
                <a id="txtDl" class="btn btn-dark" target="_blank">ä¸‹è½½</a>
            </div>
        </div>

        <div id="console" class="console"></div>
    </div>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">é…ç½®è®¢é˜…æº</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-3"><label class="form-label">è®¢é˜…åç§°</label><input type="text" id="editName" class="form-control"></div>
                <div class="mb-3"><label class="form-label">è®¢é˜…é“¾æ¥ (M3U/TXT)</label><input type="text" id="editUrl" class="form-control"></div>
                <div class="mb-3"><label class="form-label">å¹¶å‘çº¿ç¨‹ (æ¨è 5-10)</label><input type="number" id="editThreads" class="form-control" value="5"></div>
                <div class="mb-3">
                    <label class="form-label">æ‰§è¡Œæ¨¡å¼</label>
                    <select id="editMode" class="form-select" onchange="toggleEditFields()">
                        <option value="none">æ‰‹åŠ¨æ‰§è¡Œ</option>
                        <option value="fixed">æ–¹å¼1: å®šæ—¶ç‚¹ (æ¯æ—¥ HH:MM)</option>
                        <option value="interval">æ–¹å¼2: æ—¶é—´é—´éš” (å°æ—¶)</option>
                    </select>
                </div>
                <div id="editFixed" class="mb-3 d-none"><input type="text" id="editTimes" class="form-control" placeholder="08:00, 20:00"></div>
                <div id="editInterval" class="mb-3 d-none"><input type="number" id="editHours" class="form-control" placeholder="12"></div>
                <div class="d-flex justify-content-between"><button class="btn btn-outline-danger btn-sm" onclick="deleteSub()" id="delBtn">åˆ é™¤è¯¥æº</button><button class="btn btn-primary" onclick="saveSub()">ä¿å­˜é…ç½®</button></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let subs = [];
    let currentId = null;
    let pollTimer = null;
    const modal = new bootstrap.Modal(document.getElementById('editModal'));

    async function loadSubs() {
        const res = await fetch('/api/subs');
        subs = await res.json();
        const list = document.getElementById('subsList');
        list.innerHTML = subs.map(s => `
            <div class="sub-item p-3 ${s.id === currentId ? 'active' : ''}" onclick="selectSub('${s.id}')">
                <div class="fw-bold">${s.name}</div>
                <div class="small text-muted text-truncate">${s.url}</div>
            </div>
        `).join('');
    }

    function selectSub(id) {
        currentId = id;
        document.getElementById('noSelect').classList.add('d-none');
        document.getElementById('dashboard').classList.remove('d-none');
        const s = subs.find(x => x.id === id);
        document.getElementById('viewName').innerText = s.name;
        document.getElementById('viewUrl').innerText = s.url;
        
        const base = window.location.origin;
        document.getElementById('m3uUrl').value = `${base}/sub/${id}.m3u`;
        document.getElementById('m3uDl').href = `/sub/${id}.m3u`;
        document.getElementById('txtUrl').value = `${base}/sub/${id}.txt`;
        document.getElementById('txtDl').href = `/sub/${id}.txt`;

        loadSubs(); 
        if(pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(updateStatus, 1500);
    }

    async function updateStatus() {
        if(!currentId) return;
        const res = await fetch('/api/status/' + currentId);
        const data = await res.json();
        
        document.getElementById('statTotal').innerText = data.total;
        document.getElementById('statCurrent').innerText = data.current;
        document.getElementById('statSuccess').innerText = data.success;
        const rate = data.current > 0 ? Math.round(data.success/data.current*100) : 0;
        document.getElementById('statRate').innerText = rate + '%';
        
        const p = data.total > 0 ? Math.round(data.current/data.total*100) : 0;
        document.getElementById('pBar').style.width = p + '%';
        document.getElementById('pText').innerText = p + '%';

        const runBtn = document.getElementById('runBtn');
        const stopBtn = document.getElementById('stopBtn');
        if(data.running) {
            runBtn.classList.add('d-none'); stopBtn.classList.remove('d-none');
        } else {
            runBtn.classList.remove('d-none'); stopBtn.classList.add('d-none');
        }

        const con = document.getElementById('console');
        con.innerHTML = data.logs.map(l => {
            let cls = "";
            if(l.includes('âœ…')) cls = "log-success";
            if(l.includes('âŒ')) cls = "log-fail";
            return `<div class="log-line ${cls}">${l}</div>`;
        }).join('');
        con.scrollTop = con.scrollHeight;
    }

    function showEditModal() {
        document.getElementById('editId').value = "";
        document.getElementById('editName').value = "";
        document.getElementById('editUrl').value = "";
        document.getElementById('delBtn').classList.add('d-none');
        modal.show();
    }

    function editCurrent() {
        const s = subs.find(x => x.id === currentId);
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editUrl').value = s.url;
        document.getElementById('editThreads').value = s.threads || 5;
        document.getElementById('editMode').value = s.schedule_mode || 'none';
        document.getElementById('editTimes').value = s.fixed_times || '';
        document.getElementById('editHours').value = s.interval_hours || 12;
        document.getElementById('delBtn').classList.remove('d-none');
        toggleEditFields();
        modal.show();
    }

    function toggleEditFields() {
        const m = document.getElementById('editMode').value;
        document.getElementById('editFixed').classList.toggle('d-none', m!=='fixed');
        document.getElementById('editInterval').classList.toggle('d-none', m!=='interval');
    }

    async function saveSub() {
        const data = {
            id: document.getElementById('editId').value,
            name: document.getElementById('editName').value,
            url: document.getElementById('editUrl').value,
            threads: document.getElementById('editThreads').value,
            schedule_mode: document.getElementById('editMode').value,
            fixed_times: document.getElementById('editTimes').value,
            interval_hours: document.getElementById('editHours').value
        };
        await fetch('/api/subs', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        modal.hide(); loadSubs();
    }

    async function deleteSub() {
        if(confirm('ç¡®è®¤å½»åº•åˆ é™¤è¯¥è®¢é˜…æºå—ï¼Ÿ')) {
            await fetch('/api/subs/delete/' + currentId);
            modal.hide(); currentId = null; 
            document.getElementById('dashboard').classList.add('d-none');
            document.getElementById('noSelect').classList.remove('d-none');
            loadSubs();
        }
    }

    function startTask() { fetch('/api/start/' + currentId); }
    function stopTask() { fetch('/api/stop/' + currentId); }
    function copyUrl(id) {
        const el = document.getElementById(id);
        el.select(); document.execCommand('copy'); alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
    function toggleEditFields() {
        const m = document.getElementById('editMode').value;
        document.getElementById('editFixed').classList.toggle('d-none', m!=='fixed');
        document.getElementById('editInterval').classList.toggle('d-none', m!=='interval');
    }

    window.onload = loadSubs;
</script>
</body>
</html>
