<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m3u-checker | æœ¬åœ°æ£€æµ‹ä¸è‡ªåŠ¨åŒ–åŠ©æ‰‹</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --console-bg: #1e1e1e;
            --console-text: #d4d4d4;
            --success-color: #4ec9b0;
            --error-color: #f48771;
            --info-color: #569cd6;
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: #333;
        }

        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-weight: 600;
            color: #4a4a4a;
            border-left: 4px solid #0d6efd;
            padding-left: 10px;
            margin-bottom: 1.25rem;
        }

        /* æ§åˆ¶å°æ ·å¼ */
        .console {
            background-color: var(--console-bg);
            color: var(--console-text);
            padding: 15px;
            border-radius: 8px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid #333;
        }

        .log-line { margin-bottom: 4px; }
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-info { color: var(--info-color); }

        /* çŠ¶æ€å¾®ç«  */
        .status-badge {
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 20px;
        }

        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress {
            height: 12px;
            border-radius: 10px;
            background-color: #e9ecef;
        }

        textarea.form-control {
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #fafafa;
        }

        .btn-group-custom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* éšè—å­—æ®µåŠ¨ç”» */
        .d-none { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white">
    <div class="container">
        <span class="navbar-brand mb-0 h1 text-primary">ğŸ“º m3u-checker</span>
        <span class="text-muted small">Local IPTV Inspector & Automator</span>
    </div>
</nav>

<div class="container pb-5">
    <div class="row">
        <!-- å·¦ä¾§é…ç½®æ  -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">åŸºç¡€é…ç½®</h5>
                    <div class="mb-3">
                        <label class="form-label fw-bold">è®¢é˜…é“¾æ¥ (æ¯è¡Œä¸€ä¸ª)</label>
                        <textarea id="urlInput" class="form-control" rows="8" placeholder="https://raw.githubusercontent.com/.../iptv.m3u"></textarea>
                    </div>

                    <h5 class="card-title mt-4">è‡ªåŠ¨åŒ–è®¡åˆ’</h5>
                    <div class="mb-3">
                        <label class="form-label">æ‰§è¡Œæ¨¡å¼</label>
                        <select id="scheduleMode" class="form-select" onchange="toggleScheduleFields()">
                            <option value="none">æ‰‹åŠ¨æ¨¡å¼ (ä¸è‡ªåŠ¨æ‰§è¡Œ)</option>
                            <option value="fixed">æ–¹å¼ 1ï¼šå›ºå®šæ—¶é—´ç‚¹ (æ¯æ—¥æ‰§è¡Œ)</option>
                            <option value="interval">æ–¹å¼ 2ï¼šå›ºå®šé—´éš” (æ¯éš”å‡ å°æ—¶)</option>
                        </select>
                    </div>

                    <div id="fixedFields" class="mb-3 d-none fade-in">
                        <label class="form-label">æ‰§è¡Œæ—¶é—´ç‚¹ (æ ¼å¼ HH:MMï¼Œé€—å·åˆ†éš”)</label>
                        <input type="text" id="fixedTimes" class="form-control" placeholder="07:00, 12:30, 21:00">
                        <div class="form-text text-muted small">æœ€å¤šå»ºè®® 5 ä¸ªç‚¹ï¼Œä¾‹å¦‚ï¼š08:00, 20:00</div>
                    </div>

                    <div id="intervalFields" class="mb-3 d-none fade-in">
                        <label class="form-label">æ‰§è¡Œé—´éš” (å°æ—¶)</label>
                        <input type="number" id="intervalHours" class="form-control" placeholder="12" min="1">
                        <div class="form-text text-muted small">æ¯éš” N å°æ—¶è‡ªåŠ¨æ£€æµ‹ä¸€æ¬¡</div>
                    </div>

                    <div class="alert alert-info py-2 mt-3">
                        <small>ğŸ“… ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œæ—¶é—´: <strong id="nextRun">--</strong></small>
                    </div>

                    <div class="btn-group-custom mt-4">
                        <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button id="runBtn" class="btn btn-success" onclick="startManual()">ğŸš€ ç«‹å³å¼€å§‹æ£€æµ‹</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ç»“æœå¯¼å‡º</h5>
                    <div class="d-flex gap-2">
                        <a href="/download/iptv.m3u" class="btn btn-outline-dark flex-grow-1" target="_blank">ğŸ“„ ä¸‹è½½ M3U</a>
                        <a href="/download/iptv.txt" class="btn btn-outline-dark flex-grow-1" target="_blank">ğŸ“ ä¸‹è½½ TXT</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ç›‘æ§æ  -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">å®æ—¶ç›‘æ§</h5>
                        <span id="taskStatusBadge" class="status-badge bg-secondary text-white">ç­‰å¾…ä¸­</span>
                    </div>

                    <div class="row g-2 mb-3 text-center">
                        <div class="col-4">
                            <div class="p-2 border rounded bg-light">
                                <div class="small text-muted">æ€»æ•°</div>
                                <div id="totalCount" class="h5 mb-0">0</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded bg-light">
                                <div class="small text-muted">å·²å¤„ç†</div>
                                <div id="currentCount" class="h5 mb-0">0</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded bg-light">
                                <div class="small text-muted">æœ‰æ•ˆæº</div>
                                <div id="successCount" class="h5 mb-0 text-success">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-4">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
                    </div>

                    <div id="console" class="console">
                        <div class="log-line text-muted">// ç»ˆç«¯å°±ç»ªï¼Œç­‰å¾…ä»»åŠ¡å¯åŠ¨...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let refreshTimer = null;

    // é¡µé¢åˆå§‹åŒ–ï¼šåŠ è½½é…ç½®çŠ¶æ€
    window.onload = function() {
        refreshStatus();
        // å¼€å¯è‡ªåŠ¨åˆ·æ–°æ—¥å¿—
        setInterval(refreshStatus, 2000);
    };

    function toggleScheduleFields() {
        const mode = document.getElementById('scheduleMode').value;
        document.getElementById('fixedFields').classList.toggle('d-none', mode !== 'fixed');
        document.getElementById('intervalFields').classList.toggle('d-none', mode !== 'interval');
    }

    // ä¿å­˜è®¾ç½®å¹¶åŒæ­¥å®šæ—¶å™¨
    function saveSettings() {
        const data = {
            urls: document.getElementById('urlInput').value.split('\n').filter(u => u.trim() !== ""),
            schedule_mode: document.getElementById('scheduleMode').value,
            fixed_times: document.getElementById('fixedTimes').value,
            interval_hours: document.getElementById('intervalHours').value
        };

        fetch('/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if(res.status === 'success') {
                document.getElementById('nextRun').innerText = res.next_run;
                alert('âœ… é…ç½®æˆåŠŸï¼å®šæ—¶ä»»åŠ¡å·²æ›´æ–°ã€‚');
            }
        })
        .catch(err => alert('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯è¿æ¥ã€‚'));
    }

    // æ‰‹åŠ¨å¯åŠ¨ä»»åŠ¡
    function startManual() {
        document.getElementById('runBtn').disabled = true;
        fetch('/start')
        .then(() => {
            console.log("Task started");
        });
    }

    // åˆ·æ–°é¡µé¢çŠ¶æ€
    function refreshStatus() {
        fetch('/status')
        .then(res => res.json())
        .then(data => {
            const con = document.getElementById('console');
            const pbar = document.getElementById('progressBar');
            const badge = document.getElementById('taskStatusBadge');

            // 1. æ›´æ–°è®¡æ•°å’Œè¿›åº¦
            document.getElementById('totalCount').innerText = data.total || 0;
            document.getElementById('currentCount').innerText = data.current || 0;
            document.getElementById('successCount').innerText = data.success || 0;
            document.getElementById('nextRun').innerText = data.next_run || 'æœªè®¾ç½®';

            if(data.total > 0) {
                let percent = Math.round((data.current / data.total) * 100);
                pbar.style.width = percent + '%';
                pbar.innerText = percent + '%';
            }

            // 2. æ›´æ–°çŠ¶æ€å¾½ç« 
            if(data.running) {
                badge.innerText = "è¿è¡Œä¸­";
                badge.className = "status-badge bg-primary text-white";
                document.getElementById('runBtn').disabled = true;
            } else {
                badge.innerText = "ç©ºé—²";
                badge.className = "status-badge bg-secondary text-white";
                document.getElementById('runBtn').disabled = false;
            }

            // 3. å¤„ç†æ—¥å¿—æ˜¾ç¤º
            if(data.logs && data.logs.length > 0) {
                con.innerHTML = data.logs.map(line => {
                    let typeClass = "";
                    if(line.includes('âœ…')) typeClass = "log-success";
                    else if(line.includes('âŒ') || line.includes('Error')) typeClass = "log-error";
                    else if(line.includes('â°') || line.includes('æ­£åœ¨')) typeClass = "log-info";
                    
                    return `<div class="log-line ${typeClass}">${line}</div>`;
                }).join('');
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                con.scrollTop = con.scrollHeight;
            }
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
